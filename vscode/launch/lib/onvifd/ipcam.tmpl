# Configuration is generated by onvifd from "ipcam.tmpl" template.
{{- $OnvifdAddress := .OnvifdAddress }}
{{- $RTSPStreamPort := .RTSPStreamPort }}
{{- $sslCertificate := .SSLCertificate }}
{{- $sslCertificateKey := .SSLCertificateKey }}
{{- range $key, $value := .Protocols }}
  {{- if $value.Enabled }}

server {
    {{- range $value.Port }}
    listen       {{.}};
    listen       [::]:{{.}};
    {{- end }}
    server_name  $hostname;
    {{- if eq $key "https" }}
        {{- if ne $sslCertificate ""}}
            {{- if ne $sslCertificateKey ""}}
    ssl_certificate           {{$sslCertificate}};
    ssl_certificate_key       {{$sslCertificateKey}};

    ssl on;
    ssl_session_cache  builtin:1000  shared:SSL:10m;
    ssl_protocols  TLSv1 TLSv1.1 TLSv1.2;
    ssl_prefer_server_ciphers on;
            {{- end}}
        {{- end}}
    {{- end }}

    location / {
        root   /www/html;
        index  index.html index.htm;
        include fcgiwrap.conf;
    }

    location /api/v2 {
        rewrite ^/api/v2/(imaging|media|recording|actionengine|ptz|security|schedule|analytics|media2|deviceio|event)$ /onvif/$1 break;
        rewrite ^/api/v2/(devicemgmt)$ /onvif/device_service break;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_pass {{$OnvifdAddress}};
    }

    location /api {
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_pass http://unix:/run/gunicorn.sock;
    }

    location /update {
        proxy_pass http://127.0.0.1:8585/upload;
        client_max_body_size 1024m;
        proxy_http_version 1.1;
        proxy_request_buffering off;
    }

    location ~ ^/.*/(snapshot|mjpeg) {
        proxy_pass http://127.0.0.1:8877;
    }

    location ~ ^/.*/(webrtc|meta) {
        proxy_pass http://127.0.0.1:8877;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    {{if $RTSPStreamPort -}}
    location /rtsp {
        websockify_pass 127.0.0.1:{{$RTSPStreamPort}};
    }
    {{- end}}

    location /onvif {
        proxy_pass {{$OnvifdAddress}};
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    location /recordings/ {
        alias /media/archive/records/;
        autoindex on;
    }

    location /upload/aplay {
        alias /var/www/aplay/aplay;
        client_body_temp_path /var/www/tmp;
        create_full_put_path on;
        client_max_body_size 16m;
        dav_methods PUT;
        dav_access all:rw;
    }

    location /devicedesc.xml {
        alias /var/www/devicedesc.xml;
    }
}
  {{- end }}
{{- end }}
