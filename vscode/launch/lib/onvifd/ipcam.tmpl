# Configuration is generated by onvifd from "ipcam.tmpl" template.
{{- $OnvifdAddress := .OnvifdAddress }}
{{- $RTSPStreamPort := .RTSPStreamPort }}
{{- $RTSPWebSocketUri := .RTSPWebSocketUri }}
{{- $sslCertificate := .SSLCertificate }}
{{- $sslCertificateKey := .SSLCertificateKey }}
{{- $faceDBUploadLimit := .FaceDBUploadLimit }}
{{- $appUploadLimit := .AppUploadLimit }}
{{- range $key, $value := .Protocols }}
  {{- if $value.Enabled }}

server {
    {{- range $value.Port }}
    listen       {{.}};
    listen       [::]:{{.}};
    {{- end }}
    server_name  $hostname;
    {{- if eq $key "https" }}
        {{- if ne $sslCertificate ""}}
            {{- if ne $sslCertificateKey ""}}
    ssl_certificate           {{$sslCertificate}};
    ssl_certificate_key       {{$sslCertificateKey}};

    ssl on;
    ssl_session_cache  builtin:1000  shared:SSL:10m;
    ssl_protocols  TLSv1 TLSv1.1 TLSv1.2;
    ssl_prefer_server_ciphers on;
            {{- end}}
        {{- end}}
    {{- end }}

    # uncomment next line to enable error/debug log:
    # error_log /var/log/nginx/error.log debug;

    location / {
        root   /www/html;
        index  index.html index.htm;
        include fcgiwrap.conf;
    }

    location /api/v2 {
        rewrite ^/api/v2/(actionengine|analytics|appmgmt|deviceio|event|imaging|media|media2|ptz|recording|schedule|security)$ /onvif/$1 break;
        rewrite ^/api/v2/(devicemgmt)$ /onvif/device_service break;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_pass {{$OnvifdAddress}};
    }

    location /api {
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_pass http://unix:/run/gunicorn.sock;
    }

    location /update {
        proxy_pass http://127.0.0.1:8585/upload;
        client_max_body_size 1024m;
        proxy_http_version 1.1;
        proxy_request_buffering off;
    }

    location ~ ^/.*/(snapshot|mjpeg) {
        proxy_pass http://127.0.0.1:8877;
    }

    location ~ ^/.*/(webrtc|meta) {
        proxy_pass http://127.0.0.1:8877;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    {{if $RTSPStreamPort -}}
    location {{$RTSPWebSocketUri}} {
        websockify_pass 127.0.0.1:{{$RTSPStreamPort}};
    }
    {{- end}}

    location /onvif {
        proxy_pass {{$OnvifdAddress}};
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    location /recordings/ {
        alias /media/archive/records/;
        autoindex on;
    }

    location /upload/aplay {
        alias /var/www/aplay/aplay;
        client_body_temp_path /var/www/tmp;
        create_full_put_path on;
        client_max_body_size 16m;
        dav_methods PUT;
        dav_access all:rw;
    }

    location ~ ^/upload/(facedb)$ {
        set $upload_type $1;
        client_max_body_size {{$faceDBUploadLimit}};
        upload_pass @upload_finished;
        upload_store /var/www/facedb/upload 1;
        upload_store_access all:rw;
        upload_set_form_field file.name "$upload_file_name";
        upload_set_form_field file.path "$upload_tmp_path";
        upload_cleanup 400-599;
        limit_except POST {
            deny all;
        }
    }

    location ~ ^/upload/(application)$ {
        set $upload_type $1;
        client_max_body_size {{$appUploadLimit}};
        upload_pass @upload_finished;
        upload_store /var/www/appmgmt/upload 1;
        upload_store_access all:rw;
        upload_set_form_field file.name "$upload_file_name";
        upload_set_form_field file.path "$upload_tmp_path";
        upload_cleanup 400-599;
        limit_except POST {
            deny all;
        }
    }

    location @upload_finished {
        proxy_pass {{$OnvifdAddress}}/upload_finished/$upload_type;
        internal;
    }

    location /devicedesc.xml {
        alias /var/www/devicedesc.xml;
    }
}
  {{- end }}
{{- end }}
